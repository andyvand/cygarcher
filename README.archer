This branch is an attempt to fix PR 12707.  However, it has some
issues; the bug links to the thread pointing them out.  Still, I think
this is a decent starting point.
